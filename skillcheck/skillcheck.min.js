var timeout,running=!1,perk_unnervingPresence=0,perk_thisIsNotHappening=0,perk_overcharge=0,sc_running=!1,sc_ready=!1,sc_type="generator",sc_line_pos=0,sc_zone_pos=0,sc_zone=[0,0],sc_zone_end_padding=3,sc_range_min=120,sc_range_max=330,stat_miss=0,stat_good=0,stat_great=0,snd_good_1=new Audio("../res/mp3/sc_good.mp3"),snd_good_2=new Audio("../res/mp3/sc_good.mp3"),snd_good_toggle=!1,snd_great_1=new Audio("../res/mp3/sc_great.mp3"),snd_great_2=new Audio("../res/mp3/sc_great.mp3"),snd_great_toggle=!1,snd_miss_1=new Audio("../res/mp3/sc_miss.mp3"),snd_miss_2=new Audio("../res/mp3/sc_miss.mp3"),snd_miss_toggle=!1,snd_open_1=new Audio("../res/mp3/sc_open.mp3"),snd_open_2=new Audio("../res/mp3/sc_open.mp3"),snd_open_toggle=!1,keyState={};function isValidTier(e){return e>0&&e<=3}function getUnnervingPresenceModifier(e){return isValidTier(e)?1-(.3+.1*e):1}function getThisIsNotHappeningModifier(e){return isValidTier(e)?1+.1*e:1}function getOverchargeSize(e){if(!isValidTier(e))return 26;switch(e){case 1:return 26;case 2:return 23;case 3:return 20}}function getSkillCheckZone(e){var n=[0,0],s=1;switch(e){case"overcharge":n=[0,getOverchargeSize(perk_overcharge)];break;case"decisive":n=[0,20];break;case"heal":case"sabotage":case"generator":n=[35,10]}if(s=getUnnervingPresenceModifier(perk_unnervingPresence),n[0]*=s,n[1]*=s,"decisive"!==e){s=getThisIsNotHappeningModifier(perk_thisIsNotHappening);var t=n[1]*s-n[1];n[0]-=t,n[1]+=t}return n}function getRandomNumber(e,n){if(e>n){var s=e;e=n,n=s}return Math.random()*(e-n)+n}function normalizeAngle(e){for(e%=360;e<0;)e+=360;return e}function toRadians(e){return normalizeAngle(e)*(Math.PI/180)}function updateText(){$("#miss").html(stat_miss),$("#good").html(stat_good),$("#great").html(stat_great),$("#start-btn").html(running?"Stop":"Start")}function handleAction(e){switch(sc_ready=!1,sc_running=!1,e){case"miss":stat_miss++,(snd_miss_toggle=!snd_miss_toggle)?snd_miss_1.play():snd_miss_2.play();break;case"great":stat_great++,(snd_great_toggle=!snd_great_toggle)?snd_great_1.play():snd_great_2.play();break;case"good":stat_good++,(snd_good_toggle=!snd_good_toggle)?snd_good_1.play():snd_good_2.play()}setTimeout(function(){sc_ready=!0},500)}function resetStats(){stat_miss=stat_great=stat_good=0}function testZone(){var e,n=sc_line_pos,s=sc_zone_pos,t=s+sc_zone[1],o=t+sc_zone[0]+sc_zone_end_padding;n<s||n>o?e="miss":n>=s&&n<=t?e="great":n>t&&n<=o&&(e="good"),handleAction(e)}function setupNewZone(){sc_line_pos=0,sc_zone=getSkillCheckZone(sc_type),sc_zone_pos=getRandomNumber(sc_range_min,sc_range_max-(sc_zone[0]+sc_zone[1]))}function newSkillCheck(){sc_running=!0,setupNewZone();var e=setInterval(function(){if(sc_running&&keyState[32])testZone();else if(sc_running){if((sc_line_pos=normalizeAngle(sc_line_pos+3.6))>sc_zone_pos+sc_zone[0]+sc_zone[1]+sc_zone_end_padding)return handleAction("miss"),void clearInterval(e);$("#sc_tick").css({transform:"rotate("+sc_line_pos+"deg)"});var n=sc_zone_pos,s=n+sc_zone[1],t=s+sc_zone[0],o=document.getElementById("sc_zone"),i=o.getContext("2d"),r=o.width/2,a=o.height/2;i.clearRect(0,0,o.width,o.height),i.lineWidth=1,i.strokeStyle="#FFFFFF",i.beginPath(),i.arc(r,a,65,toRadians(n-90),toRadians(t-90),!0),i.stroke(),i.lineWidth=7,i.beginPath(),i.arc(r,a,65,toRadians(n-90),toRadians(s-90)),i.stroke(),i.lineWidth=1,i.beginPath(),i.arc(r,a,68,toRadians(s-90),toRadians(t-90)),i.arc(r,a,62,toRadians(t-90),toRadians(s-90),!0),i.stroke()}else clearInterval(e)},10)}function runSkillChecks(){setInterval(function(){updateText(),sc_ready&&($("#skillcheck").css({opacity:0}),!sc_running&&running&&(timeout=setTimeout(function(){(snd_open_toggle=!snd_open_toggle)?snd_open_1.play():snd_open_2.play(),timeout=setTimeout(function(){$("#sc_tick").css({transform:"rotate(0deg)"}),$("#skillcheck").css({opacity:1}),newSkillCheck()},500)},getRandomNumber(1500,2500))),sc_ready=!1)},10)}function onStart(){if(running)var e=setInterval(function(){sc_running||(clearTimeout(e),clearTimeout(timeout),running=!1)},10);else sc_ready=!0,running=!running}window.addEventListener("keydown",function(e){keyState[e.keyCode||e.which]=!0,keyState[80]&&onStart()},!0),window.addEventListener("keyup",function(e){keyState[e.keyCode||e.which]=!1},!0),runSkillChecks();